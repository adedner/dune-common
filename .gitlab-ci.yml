---
include:
  - project: 'core/ci-config'
    ref: master
    file: 'config/common/master.yml'
  - project: 'core/ci-config'
    ref: master
    file: 'jobs/common/master.yml'

before_script:
  - . /duneci/bin/duneci-init-job

variables:
  DUNECI_TEST_LABELS: quick
  DUNE_TEST_EXPECTED_VC_IMPLEMENTATION: SSE2
  PIP_DEFAULT_TIMEOUT: 0
  # Note: DUNE_RUNNING_IN_CI only needed unti ci image updating fixed on gitlab
  DUNECI_CMAKE_FLAGS: '-DDUNE_RUNNING_IN_CI=TRUE'
  DUNE_LOG_LEVEL:     DEBUG

# incremental builds install packages step by step starting from a minimal image
.incremental:
  extends: .common
  image: registry.dune-project.org/docker/ci/ubuntu:18.04-minimal
  variables:
    DUNECI_TOOLCHAIN:  gcc-7-17

incremental-step0:
  extends: .incremental
  script:
    - bin/dunecontrol --opts=/duneci/dune.opts --current all

incremental-step1:
  extends: .incremental
  before_script:
    - duneci-install-package python3

incremental-step2:
  extends: .incremental
  before_script:
    - duneci-install-package python3 python3-dev

incremental-step3:
  extends: .incremental
  before_script:
    - duneci-install-package python3 python3-dev python3-venv

incremental-step4:
  extends: .incremental
  before_script:
    - duneci-install-package python3 python3-dev python3-venv python3-pip

incremental-step5:
  extends: .incremental
  before_script:
    - duneci-install-package python3 python3-dev python3-venv python3-pip python3-numpy

incremental-step6:
  extends: .incremental
  before_script:
    - duneci-install-package mpi-default-bin mpi-default-dev python3 python3-dev python3-venv python3-pip python3-numpy

incremental-step7:
  extends: .incremental
  before_script:
    - duneci-install-package mpi-default-bin mpi-default-dev python3 python3-dev python3-venv python3-pip python3-numpy python3-mpi4py


