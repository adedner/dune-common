#!/usr/bin/bash
# SPDX-FileCopyrightInfo: Copyright Â© DUNE Project contributors, see file LICENSE.md in module root
# SPDX-License-Identifier: LicenseRef-GPL-2.0-only-with-DUNE-exception

SED=@SED_PROGRAM@
GREP=@GREP_PROGRAM@
CUT=@CUT_PROGRAM@
ENV=@ENV_PROGRAM@
ECHO=@ECHO_PROGRAM@
CHMOD=@CHMOD_PROGRAM@

# store the compiler
COMPILER=$1
shift

# store flags
FLAGS="$@"
MAKE_EXECUTABLE_NEW=0

CMAKE_C_FLAGS="@CMAKE_C_FLAGS@"
CMAKE_CXX_FLAGS="@CMAKE_CXX_FLAGS@"

if [ "$@COMP@FLAGS" == "" ]; then
  # default @COMP@ flags
  @COMP@FLAGS="$CMAKE_@COMP@_FLAGS"
fi

if [ "$EXTRA_@COMP@FLAGS" != "" ]; then
  # extra @COMP@ flags
  @COMP@FLAGS="$@COMP@FLAGS $EXTRA_@COMP@FLAGS"
fi

GRIDS=
CONFIG_H=@CMAKE_BINARY_DIR@/config.h
if [ "$GRIDTYPE" != "" ]; then
  GRIDS=`$GREP "defined USED_[A-Z_]*_GRIDTYPE" $CONFIG_H | $SED 's/\(.*defined USED\_\)\(.*\)\(\_GRIDTYPE*\)/\2/g'`
fi

OLDFLAGS=$FLAGS
FLAGS=
for FLAG in $OLDFLAGS; do
  NEWFLAG=$FLAG
  VARNAME=`$ECHO $FLAG | $GREP "\-D" | $SED 's/-D//g'`
  for GRID in $GRIDS; do
    if [ "$VARNAME" == "$GRID" ]; then
      NEWFLAG="-D$GRIDTYPE"
      break
    fi
  done
  VARNAME=`$ECHO $VARNAME | $GREP "=" | $CUT -d "=" -f 1`
  if [ "$VARNAME" != "" ]; then
    VAR=`$ENV | $GREP $VARNAME`
    if [ "$VAR" != "" ]; then
      # add variable from environment to flags list
      NEWFLAG="-D$VARNAME=${!VARNAME}"
    fi
  fi
  FLAGS="$FLAGS $NEWFLAG"
done
exec $COMPILER $CXXFLAGS $FLAGS