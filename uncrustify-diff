#!/usr/bin/env python3

import subprocess
import json
import re
import sys
import tempfile
import hashlib
import os
from optparse import OptionParser


# A regex pattern to detect hunk start lines (lines beginning with @@)
hunk_start_pattern = re.compile(r'@@ -(\d+)(?:,(\d+))? \+(\d+)(?:,(\d+))? @@')
new_filename_match = re.compile(r'(---|\+\+\+) ([^\t]+)(?:\t([\d\-:\s]+))?\s*')

def uncrustify_diff(file):
    # Create a temporary file to store the uncrustify output
    with tempfile.NamedTemporaryFile(mode='w+', delete=False) as tmpfile:
        # Run uncrustify on the original file and save the formatted output in the temporary file
        subprocess.run(['uncrustify', '-q', '-c', '.uncrustify.cfg', '-f', file], stdout=tmpfile)
        tmpfile.flush()  # Ensure all data is written to the file

        # Run diff to compare the original file with the uncrustify output
        diff_command = ['diff', file, tmpfile.name, '--color=never', '--unified=0']
        diff_output = subprocess.run(diff_command, stdout=subprocess.PIPE, text=True)

    # Replace temporary file name with the original file's name in the diff output
    return diff_output.stdout.replace(tmpfile.name, file)

# Extract covered line numbers from a diff and maps them to their corresponding files.
def diff_coverage(diff):
    # Split the diff text into individual lines
    lines = diff.splitlines()

    # Initialize variables for tracking hunks and file coverage
    hunks = []
    current_hunk = []
    original_file = None
    new_file = None

    coverage = {}  # A dictionary to store file coverage (file -> covered lines)

    # Loop through each line in the diff
    for line in lines:
        # Check if the line is the start of a new hunk
        hunk_match = hunk_start_pattern.match(line)
        if hunk_match:
            # Initialize coverage for the new file if not already done
            coverage.setdefault(new_file, set())
            if current_hunk:
                # If there is a current hunk, store it before starting a new one
                hunks.append('\n'.join(current_hunk))

            # Extract the starting line and size of the added lines in the hunk
            add_line_start = int(hunk_match.group(3))
            add_line_size = int(hunk_match.group(4)  if hunk_match.group(4) else 1)

            # Mark the lines covered in this hunk in the coverage dictionary
            for i in range(add_line_start, add_line_start + add_line_size):
                coverage[new_file].add(i)

        # If the line starts with `+++`, it indicates the new filename
        elif line.startswith("+++"):
            file = new_filename_match.match(line).group(2)
            new_file = os.path.relpath(file)

    return coverage

# Split a diff string into a list of hunks, including the filenames.
def diff_by_hunks(diff):
    # Split the diff text into lines
    lines = diff.splitlines()

    # Initialize variables
    hunks = []
    current_hunk = []
    original_file = None
    new_file = None

    # Loop through each line in the diff
    for line in lines:
        if line.startswith("---"):
            original_file = line
        elif line.startswith("+++"):
            new_file = line
        elif hunk_start_pattern.match(line):
            # If we encounter a hunk start line, save the current hunk (if any)
            if current_hunk:
                hunks.append('\n'.join(current_hunk))
            current_hunk = [original_file, new_file, line]
        # If we're inside a diff section, collect lines for the current hunk
        elif original_file and new_file:
            current_hunk.append(line)
    return hunks

# keep lines of diff that are also contained in target diff
def strip_diff(diff, target_diff):

    # Parse the diff input to extract the changes
    lines = diff.strip().splitlines()
    issues = []
    original_file = None
    stripped_diff = ""
    coverage = diff_coverage(target_diff)

    hunks = diff_by_hunks(diff)
    new_hunks = []

    for hunk in hunks:
        for line in hunk.split('\n'):
            if line.startswith("---"):
                original_file = os.path.relpath(new_filename_match.match(line).group(2))
                continue
            hunk_match = hunk_start_pattern.match(line)
            if hunk_match:
                rm_line_start = int(hunk_match.group(1))
                rm_line_size = int(hunk_match.group(2) if hunk_match.group(2) else 1)
                report = False
                if original_file in coverage:
                    for i in range(rm_line_start, rm_line_start+rm_line_size):
                        report = report or (i in coverage[original_file])
                if report:
                    new_hunks.append(hunk)
                    original_file = None
                    break
    return '\n'.join(new_hunks)

# convert diff into a code climate format
def diff_to_code_climate(diff, merge_diff_coverage = None):
    lines = diff.strip().splitlines()
    issues = []
    original_file = None

    for i, line in enumerate(lines):
        hunk_match = hunk_start_pattern.match(line)
        if line.startswith("---"):
            original_file = os.path.relpath(new_filename_match.match(line).group(2))
        if hunk_match:
            rm_line_start = int(hunk_match.group(1))
            rm_line_size = int(hunk_match.group(2) if hunk_match.group(2) else 1)
            add_line_size = int(hunk_match.group(4)  if hunk_match.group(4) else 1)
            diff_dump = str.join('\n', lines[i+1:i+1+rm_line_size+add_line_size])
            issue = {
                "check_name": "uncrustify",
                "description": f"Non-conforming format",
                "severity": "minor",
                "fingerprint": hashlib.sha256(diff_dump.encode()).hexdigest(),
                "location": {
                    "path": original_file,
                    "lines": {
                        "begin": rm_line_start
                    }
                }
            }
            issues.append(issue)
    return issues

if __name__ == "__main__":
    parser = OptionParser()
    parser.add_option("--format", dest="format",
                  help="format to write output", default="code-climate", choices=["diff","code-climate"])
    parser.add_option("--target-diff", dest="target_diff",
                  help="Compare uncrusify results with diff file. If uncrusify targets the same lines, it will report those.")
    (options, args) = parser.parse_args()

    diff = ""
    for file in args:
        diff = diff + uncrustify_diff(file)

    if options.target_diff:
        with open(options.target_diff) as f:
            diff = strip_diff(diff, f.read())

    if (options.format == "code-climate"):
        print(json.dumps(diff_to_code_climate(diff)))
    elif (options.format == "diff"):
        print(diff)
